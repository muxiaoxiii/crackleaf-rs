name: package

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x64
            target: x86_64-pc-windows-msvc
          - arch: x86
            target: i686-pc-windows-msvc
    env:
      QPDF_VERSION: "12.2.0"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Download qpdf (Windows)
        shell: pwsh
        run: |
          $ver = "${{ env.QPDF_VERSION }}"
          $arch = "${{ matrix.arch }}"
          $variant = if ($arch -eq "x64") { "msvc64" } else { "msvc32" }
          $url = "https://github.com/qpdf/qpdf/releases/download/v$ver/qpdf-$ver-$variant.zip"
          $zip = "qpdf.zip"
          $dest = "qpdf-temp"
          New-Item -ItemType Directory -Force -Path "tools" | Out-Null
          Invoke-WebRequest $url -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath $dest
          Copy-Item "$dest\\*\\bin\\*" "tools" -Recurse -Force
      - name: Build CrackLeaf
        shell: pwsh
        run: cargo build --release --target ${{ matrix.target }}
      - name: Assemble dist
        shell: pwsh
        run: |
          $dist = "dist-${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path $dist | Out-Null
          Copy-Item "target/${{ matrix.target }}/release/crackleaf-rs.exe" "$dist/CrackLeaf.exe"
          $qpdf = Get-ChildItem "$env:GITHUB_WORKSPACE/tools" -Filter qpdf.exe | Select-Object -First 1
          if ($null -eq $qpdf) { throw "qpdf.exe not found" }
          Copy-Item $qpdf.FullName "$dist/qpdf.exe"
          Copy-Item "assets" "$dist/assets" -Recurse
          if (Test-Path "tools") {
            Get-ChildItem "tools" -Filter "*.dll" | ForEach-Object { Copy-Item $_.FullName "$dist/" }
          }
      - name: Zip
        shell: pwsh
        run: |
          $zip = "CrackLeaf-win-${{ matrix.arch }}.zip"
          if (Test-Path $zip) { Remove-Item $zip }
          Push-Location "dist-${{ matrix.arch }}"
          Compress-Archive -Path * -DestinationPath "../$zip"
          Pop-Location
      - uses: actions/upload-artifact@v4
        with:
          name: CrackLeaf-win-${{ matrix.arch }}
          path: CrackLeaf-win-${{ matrix.arch }}.zip

  macos:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-14
            arch: arm64
            target: ""
          - os: macos-14-large
            arch: x86_64
            target: x86_64-apple-darwin
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
      QPDF_VERSION: "12.2.0"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        if: ${{ matrix.target != '' }}
        with:
          targets: ${{ matrix.target }}
      - uses: dtolnay/rust-toolchain@stable
        if: ${{ matrix.target == '' }}
      - name: Install cargo-bundle
        run: cargo install cargo-bundle
      - name: Build app
        run: |
          if [ -n "${{ matrix.target }}" ]; then
            cargo bundle --release --target ${{ matrix.target }}
          else
            cargo bundle --release
          fi
      - name: Copy assets into app bundle
        run: |
          if [ -n "${{ matrix.target }}" ]; then
            APP_PATH="target/${{ matrix.target }}/release/bundle/osx/CrackLeaf.app"
          else
            APP_PATH="target/release/bundle/osx/CrackLeaf.app"
          fi
          mkdir -p "$APP_PATH/Contents/Resources/assets"
          cp -R assets/* "$APP_PATH/Contents/Resources/assets/"
      - name: Build qpdf from source (static)
        run: |
          if [ -n "${{ matrix.target }}" ]; then
            APP_PATH="target/${{ matrix.target }}/release/bundle/osx/CrackLeaf.app"
          else
            APP_PATH="target/release/bundle/osx/CrackLeaf.app"
          fi
          brew install cmake ninja openssl@3 zlib libjpeg-turbo
          OPENSSL_PREFIX="$(brew --prefix openssl@3)"
          ZLIB_PREFIX="$(brew --prefix zlib)"
          JPEG_PREFIX="$(brew --prefix libjpeg-turbo)"
          curl -L "https://github.com/qpdf/qpdf/releases/download/v${QPDF_VERSION}/qpdf-${QPDF_VERSION}.tar.gz" -o qpdf.tar.gz
          tar -xf qpdf.tar.gz
          mkdir -p qpdf-build qpdf-install
          cmake -S "qpdf-${QPDF_VERSION}" -B qpdf-build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="$PWD/qpdf-install" \
            -DBUILD_SHARED_LIBS=OFF \
            -DQPDF_BUILD_TESTS=OFF \
            -DQPDF_BUILD_DOCS=OFF \
            -DOPENSSL_ROOT_DIR="$OPENSSL_PREFIX" \
            -DZLIB_ROOT="$ZLIB_PREFIX" \
            -DJPEG_ROOT="$JPEG_PREFIX"
          cmake --build qpdf-build
          cmake --install qpdf-build
          cp "qpdf-install/bin/qpdf" "$APP_PATH/Contents/MacOS/qpdf"
          chmod +x "$APP_PATH/Contents/MacOS/qpdf"
          bundle_deps_recursive() {
            local target="$1"
            local app_dir="$2"
            local deps
            deps=$(otool -L "$target" | awk 'NR>1 {print $1}' | grep -E '^(/opt/homebrew|/usr/local)/' || true)
            for dep in $deps; do
              local name
              name=$(basename "$dep")
              local copied="$app_dir/$name"
              install_name_tool -change "$dep" "@executable_path/$name" "$target"
              if [ ! -f "$copied" ]; then
                cp "$dep" "$copied"
                chmod 644 "$copied"
                install_name_tool -id "@executable_path/$name" "$copied"
                bundle_deps_recursive "$copied" "$app_dir"
              fi
            done
          }
          bundle_deps_recursive "$APP_PATH/Contents/MacOS/qpdf" "$APP_PATH/Contents/MacOS"
      - name: Create dmg (drag to Applications)
        run: |
          if [ -n "${{ matrix.target }}" ]; then
            APP_PATH="target/${{ matrix.target }}/release/bundle/osx/CrackLeaf.app"
          else
            APP_PATH="target/release/bundle/osx/CrackLeaf.app"
          fi
          STAGING="dist/dmg/CrackLeaf-${{ matrix.arch }}"
          rm -rf "$STAGING"
          mkdir -p "$STAGING"
          cp -R "$APP_PATH" "$STAGING/"
          ln -s /Applications "$STAGING/Applications"
          hdiutil create -volname "CrackLeaf" -srcfolder "$STAGING" -ov -format UDZO "CrackLeaf-mac-${{ matrix.arch }}.dmg"
      - uses: actions/upload-artifact@v4
        with:
          name: CrackLeaf-mac-${{ matrix.arch }}-dmg
          path: CrackLeaf-mac-${{ matrix.arch }}.dmg

  release:
    runs-on: ubuntu-latest
    needs: [windows, macos]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Read version
        id: version
        run: |
          VERSION=$(awk -F\" '/^version =/ {print $2; exit}' Cargo.toml)
          if [ -z "$VERSION" ]; then echo "version not found"; exit 1; fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Collect artifacts
        run: |
          mkdir -p release
          find dist -type f \( -name "*.zip" -o -name "*.dmg" \) -print0 | xargs -0 -I{} cp {} release/
          ls -la release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}-build.${{ github.run_number }}
          target_commitish: ${{ github.sha }}
          files: release/*
