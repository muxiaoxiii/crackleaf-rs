name: package

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x64
            target: x86_64-pc-windows-msvc
          - arch: x86
            target: i686-pc-windows-msvc
    env:
      QPDF_VERSION: "12.2.0"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Download qpdf (Windows)
        shell: pwsh
        run: |
          $ver = "${{ env.QPDF_VERSION }}"
          $arch = "${{ matrix.arch }}"
          $variant = if ($arch -eq "x64") { "msvc64" } else { "msvc32" }
          $url = "https://github.com/qpdf/qpdf/releases/download/v$ver/qpdf-$ver-$variant.zip"
          $zip = "qpdf.zip"
          $dest = "qpdf-temp"
          New-Item -ItemType Directory -Force -Path "tools" | Out-Null
          Invoke-WebRequest $url -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath $dest
          Copy-Item "$dest\\*\\bin\\*" "tools" -Recurse -Force
      - name: Build CrackLeaf
        shell: pwsh
        run: cargo build --release --target ${{ matrix.target }}
      - name: Assemble dist
        shell: pwsh
        run: |
          $dist = "dist-${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path $dist | Out-Null
          Copy-Item "target/${{ matrix.target }}/release/crackleaf-rs.exe" "$dist/CrackLeaf.exe"
          $qpdf = Get-ChildItem "$env:GITHUB_WORKSPACE/tools" -Filter qpdf.exe | Select-Object -First 1
          if ($null -eq $qpdf) { throw "qpdf.exe not found" }
          Copy-Item $qpdf.FullName "$dist/qpdf.exe"
          Copy-Item "assets" "$dist/assets" -Recurse
          if (Test-Path "tools") {
            Get-ChildItem "tools" -Filter "*.dll" | ForEach-Object { Copy-Item $_.FullName "$dist/" }
          }
      - name: Zip
        shell: pwsh
        run: |
          $zip = "CrackLeaf-win-${{ matrix.arch }}.zip"
          if (Test-Path $zip) { Remove-Item $zip }
          Push-Location "dist-${{ matrix.arch }}"
          Compress-Archive -Path * -DestinationPath "../$zip"
          Pop-Location
      - uses: actions/upload-artifact@v4
        with:
          name: CrackLeaf-win-${{ matrix.arch }}
          path: CrackLeaf-win-${{ matrix.arch }}.zip

  windows-universal:
    runs-on: windows-latest
    needs: windows
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: CrackLeaf-win-x64
          path: dist/x64
      - uses: actions/download-artifact@v4
        with:
          name: CrackLeaf-win-x86
          path: dist/x86
      - name: Assemble universal zip
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist/universal | Out-Null
          Expand-Archive dist/x64/CrackLeaf-win-x64.zip -DestinationPath dist/universal/x64
          Expand-Archive dist/x86/CrackLeaf-win-x86.zip -DestinationPath dist/universal/x86
          Push-Location dist/universal
          Compress-Archive -Path * -DestinationPath "../../CrackLeaf-win-universal.zip"
          Pop-Location
      - uses: actions/upload-artifact@v4
        with:
          name: CrackLeaf-win-universal
          path: CrackLeaf-win-universal.zip

  macos:
    runs-on: macos-14
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin
      - name: Install cargo-bundle
        run: cargo install cargo-bundle
      - name: Build arm64 app
        run: cargo bundle --release
      - name: Build x86_64 app
        run: cargo bundle --release --target x86_64-apple-darwin
      - name: Copy assets into app bundles
        run: |
          ARM_APP="target/release/bundle/osx/CrackLeaf.app"
          X86_APP="target/x86_64-apple-darwin/release/bundle/osx/CrackLeaf.app"
          mkdir -p "$ARM_APP/Contents/Resources/assets"
          mkdir -p "$X86_APP/Contents/Resources/assets"
          cp -R assets/* "$ARM_APP/Contents/Resources/assets/"
          cp -R assets/* "$X86_APP/Contents/Resources/assets/"
      - name: Create universal app
        run: |
          ARM_APP="target/release/bundle/osx/CrackLeaf.app"
          X86_APP="target/x86_64-apple-darwin/release/bundle/osx/CrackLeaf.app"
          UNIVERSAL_APP="target/universal/CrackLeaf.app"
          rm -rf "$UNIVERSAL_APP"
          mkdir -p "target/universal"
          cp -R "$ARM_APP" "$UNIVERSAL_APP"
          ARM_BIN="$(ls "$ARM_APP/Contents/MacOS" | head -n 1)"
          X86_BIN="$(ls "$X86_APP/Contents/MacOS" | head -n 1)"
          if [ "$ARM_BIN" != "$X86_BIN" ]; then
            echo "Mismatched bundle binary names: $ARM_BIN vs $X86_BIN" >&2
            exit 1
          fi
          lipo -create "$ARM_APP/Contents/MacOS/$ARM_BIN" "$X86_APP/Contents/MacOS/$X86_BIN" -output "$UNIVERSAL_APP/Contents/MacOS/$ARM_BIN"
      - name: Zip apps
        run: |
          zip -r CrackLeaf-mac-arm64.app.zip "target/release/bundle/osx/CrackLeaf.app"
          zip -r CrackLeaf-mac-x86_64.app.zip "target/x86_64-apple-darwin/release/bundle/osx/CrackLeaf.app"
          zip -r CrackLeaf-mac-universal.app.zip "target/universal/CrackLeaf.app"
      - name: Create dmg (drag to Applications)
        run: |
          mkdir -p dist/dmg
          for APP in arm64 x86_64 universal; do
            APP_PATH="target/release/bundle/osx/CrackLeaf.app"
            if [ "$APP" = "x86_64" ]; then APP_PATH="target/x86_64-apple-darwin/release/bundle/osx/CrackLeaf.app"; fi
            if [ "$APP" = "universal" ]; then APP_PATH="target/universal/CrackLeaf.app"; fi
            STAGING="dist/dmg/CrackLeaf-$APP"
            rm -rf "$STAGING"
            mkdir -p "$STAGING"
            cp -R "$APP_PATH" "$STAGING/"
            ln -s /Applications "$STAGING/Applications"
            hdiutil create -volname "CrackLeaf" -srcfolder "$STAGING" -ov -format UDZO "CrackLeaf-mac-$APP.dmg"
          done
      - uses: actions/upload-artifact@v4
        with:
          name: CrackLeaf-mac-arm64
          path: CrackLeaf-mac-arm64.app.zip
      - uses: actions/upload-artifact@v4
        with:
          name: CrackLeaf-mac-x86_64
          path: CrackLeaf-mac-x86_64.app.zip
      - uses: actions/upload-artifact@v4
        with:
          name: CrackLeaf-mac-universal
          path: CrackLeaf-mac-universal.app.zip
      - uses: actions/upload-artifact@v4
        with:
          name: CrackLeaf-mac-arm64-dmg
          path: CrackLeaf-mac-arm64.dmg
      - uses: actions/upload-artifact@v4
        with:
          name: CrackLeaf-mac-x86_64-dmg
          path: CrackLeaf-mac-x86_64.dmg
      - uses: actions/upload-artifact@v4
        with:
          name: CrackLeaf-mac-universal-dmg
          path: CrackLeaf-mac-universal.dmg

  release:
    runs-on: ubuntu-latest
    needs: [windows, windows-universal, macos]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Read version
        id: version
        run: |
          VERSION=$(awk -F\" '/^version =/ {print $2; exit}' Cargo.toml)
          if [ -z \"$VERSION\" ]; then echo \"version not found\"; exit 1; fi
          echo \"version=$VERSION\" >> \"$GITHUB_OUTPUT\"
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Collect artifacts
        run: |
          mkdir -p release
          find dist -type f \( -name "*.zip" -o -name "*.dmg" \) -print0 | xargs -0 -I{} cp {} release/
          ls -la release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}-build.${{ github.run_number }}
          target_commitish: ${{ github.sha }}
          files: release/*
