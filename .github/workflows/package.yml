name: package

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x64
            target: x86_64-pc-windows-msvc
          - arch: x86
            target: i686-pc-windows-msvc
    env:
      QPDF_VERSION: "12.2.0"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Download qpdf (Windows)
        shell: pwsh
        run: |
          $ver = "${{ env.QPDF_VERSION }}"
          $arch = "${{ matrix.arch }}"
          $variant = if ($arch -eq "x64") { "msvc64" } else { "msvc32" }
          $url = "https://github.com/qpdf/qpdf/releases/download/v$ver/qpdf-$ver-$variant.zip"
          $zip = "qpdf.zip"
          $dest = "qpdf-temp"
          New-Item -ItemType Directory -Force -Path "tools" | Out-Null
          Invoke-WebRequest $url -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath $dest
          Copy-Item "$dest\\*\\bin\\*" "tools" -Recurse -Force
      - name: Build CrackLeaf
        shell: pwsh
        run: cargo build --release --target ${{ matrix.target }}
      - name: Assemble dist
        shell: pwsh
        run: |
          $dist = "dist-${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path $dist | Out-Null
          Copy-Item "target/${{ matrix.target }}/release/crackleaf-rs.exe" "$dist/CrackLeaf.exe"
          $qpdf = Get-ChildItem "$env:GITHUB_WORKSPACE/tools" -Filter qpdf.exe | Select-Object -First 1
          if ($null -eq $qpdf) { throw "qpdf.exe not found" }
          Copy-Item $qpdf.FullName "$dist/qpdf.exe"
          Copy-Item "assets" "$dist/assets" -Recurse
          if (Test-Path "tools") {
            Get-ChildItem "tools" -Filter "*.dll" | ForEach-Object { Copy-Item $_.FullName "$dist/" }
          }
      - name: Zip
        shell: pwsh
        run: |
          $zip = "CrackLeaf-win-${{ matrix.arch }}.zip"
          if (Test-Path $zip) { Remove-Item $zip }
          Push-Location "dist-${{ matrix.arch }}"
          Compress-Archive -Path * -DestinationPath "../$zip"
          Pop-Location
      - uses: actions/upload-artifact@v4
        with:
          name: CrackLeaf-win-${{ matrix.arch }}
          path: CrackLeaf-win-${{ matrix.arch }}.zip

  macos:
    runs-on: macos-14
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
      QPDF_VERSION: "12.2.0"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Prepare app icon (macOS)
        run: |
          ICONSET="assets/crackleaf.iconset"
          PNG="assets/crackleaf.png"
          ICNS="assets/crackleaf.icns"
          rm -rf "$ICONSET"
          mkdir -p "$ICONSET"
          for size in 16 32 64 128 256 512; do
            sips -z $size $size "$PNG" --out "$ICONSET/icon_${size}x${size}.png" >/dev/null
            sips -z $((size*2)) $((size*2)) "$PNG" --out "$ICONSET/icon_${size}x${size}@2x.png" >/dev/null
          done
          iconutil -c icns "$ICONSET" -o "$ICNS"
      - name: Install cargo-bundle
        run: cargo install cargo-bundle
      - name: Build app
        run: cargo bundle --release
      - name: Copy assets into app bundle
        run: |
          APP_PATH="target/release/bundle/osx/CrackLeaf.app"
          mkdir -p "$APP_PATH/Contents/Resources/assets"
          cp -R assets/* "$APP_PATH/Contents/Resources/assets/"
      - name: Build qpdf from source (static)
        run: |
          APP_PATH="target/release/bundle/osx/CrackLeaf.app"
          brew install cmake ninja openssl@3 zlib libjpeg-turbo dylibbundler
          OPENSSL_PREFIX="$(brew --prefix openssl@3)"
          ZLIB_PREFIX="$(brew --prefix zlib)"
          JPEG_PREFIX="$(brew --prefix libjpeg-turbo)"
          curl -L "https://github.com/qpdf/qpdf/releases/download/v${QPDF_VERSION}/qpdf-${QPDF_VERSION}.tar.gz" -o qpdf.tar.gz
          tar -xf qpdf.tar.gz
          mkdir -p qpdf-build qpdf-install
          cmake -S "qpdf-${QPDF_VERSION}" -B qpdf-build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX="$PWD/qpdf-install" \
            -DBUILD_SHARED_LIBS=OFF \
            -DQPDF_BUILD_TESTS=OFF \
            -DQPDF_BUILD_DOCS=OFF \
            -DOPENSSL_ROOT_DIR="$OPENSSL_PREFIX" \
            -DZLIB_ROOT="$ZLIB_PREFIX" \
            -DJPEG_ROOT="$JPEG_PREFIX"
          cmake --build qpdf-build
          cmake --install qpdf-build
          cp "qpdf-install/bin/qpdf" "$APP_PATH/Contents/MacOS/qpdf"
          chmod +x "$APP_PATH/Contents/MacOS/qpdf"
          dylibbundler -b \
            -x "$APP_PATH/Contents/MacOS/qpdf" \
            -d "$APP_PATH/Contents/MacOS" \
            -p "@executable_path"
      - name: Create dmg (drag to Applications)
        run: |
          APP_PATH="target/release/bundle/osx/CrackLeaf.app"
          STAGING="dist/dmg/CrackLeaf-arm64"
          rm -rf "$STAGING"
          mkdir -p "$STAGING"
          cp -R "$APP_PATH" "$STAGING/"
          ln -s /Applications "$STAGING/Applications"
          hdiutil create -volname "CrackLeaf" -srcfolder "$STAGING" -ov -format UDZO "CrackLeaf-mac-arm64.dmg"
      - uses: actions/upload-artifact@v4
        with:
          name: CrackLeaf-mac-arm64-dmg
          path: CrackLeaf-mac-arm64.dmg

  release:
    runs-on: ubuntu-latest
    needs: [windows, macos]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Read version
        id: version
        run: |
          VERSION=$(awk -F\" '/^version =/ {print $2; exit}' Cargo.toml)
          if [ -z "$VERSION" ]; then echo "version not found"; exit 1; fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Collect artifacts
        run: |
          mkdir -p release
          find dist -type f \( -name "*.zip" -o -name "*.dmg" \) -print0 | xargs -0 -I{} cp {} release/
          ls -la release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}-build.${{ github.run_number }}
          target_commitish: ${{ github.sha }}
          files: release/*
